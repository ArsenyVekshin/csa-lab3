# Лабараторная работа №3

---
Векшин Арсений Иванович P3216   
`asm | stack | neum | hw | instr |struct | stream | mem | pstr | prob2 `   
Упрощенный вариант

## Язык программирования

---

### Синтаксис

### Особенности языка

### Система команд

| __Инструкция__ | __Стек__                    | __Описание__                                                                     |
|----------------|-----------------------------|----------------------------------------------------------------------------------|
| cla            | (... a b) --> (... a b 0)   | Поместить 0 на вершину стека                                                     |
| neg            | (... a ) --> (... a * (-1)) | Арифметическое * (-1)                                                            |
| inc            | (... a) --> (... a + 1)     | +1 к значению на вершине стека                                                   |
| dec            | (... a) --> (... a - 1)     | -1 к значению на вершине стека                                                   |
|                |                             |
| not            | (... a ) --> (... ~a)       | Логическое НЕ вершины стека                                                      |
| and            | (... a b) --> (... a & b)   | Логическое И двух верхних значений стека, результат поместить на вершину стека   |
| or             | (... a b) --> (... a or b)  | Логическое ИЛИ двух верхних значений стека, результат поместить на вершину стека |
|                |                             |                                                                                  |
| add            | (... a b) --> (... a + b)   | Складываем два верхних числа со стека и кладем на вершину сумму                  |
| sub            | (... a b) --> (... a - b)   | Вычитаем из a число b и кладем разность на вершину                               |
| mul            | (... a b) --> (... a * b)   | Умножаем два верхних числа со стека и кладем на вершину результат                |
| div            | (... a b) --> (... a / b)   | Делим a на число b и кладем результат на вершину стека                           |
|                |                             |                                                                                  |
| swap           | (... a b) --> (... b a)     | Меняет местами два числа, которые лежат на вершине стека                         |
| dup            | (... a) --> (... a a)       | Дублирует число с вершины стека и кладет дубликат на вершину                     |
| pop            | (... a) --> (...)           | Удаляет число с вершины стека                                                    |
|                |                             |                                                                                  |
| beq            | if (a == b): IP + 1 --> IP  | Если a равно b, то, пропуск следующей ячейки                                     |
| bgt            | if (a > b):  IP + 1 --> IP  | Если b больше a, то, пропуск следующей ячейки                                    |
| blt            | if (a < b):  IP + 1 --> IP  | Если b меньше a, то, пропуск следующей ячейки                                    |
|                |                             |                                                                                  |
| jmp ADDR       |                             | Безусловный переход к инструкции по адресу ADDR                                  |
| call ADDR      |                             | Вызов подпрограммы по адресу ADDR                                                |
| ret            |                             | Возврат из подпрограммы                                                          |
|                |                             |                                                                                  |
| in ID          |                             | отправить статус "готов" для ввода на ВУ-ID                                      |
| out ID         |                             | отправить статус "готов" для вывода на ВУ-ID                                     |
|                |                             |                                                                                  |
| hlt            |                             | Завершение работы программы                                                      |

### Типы адресации

| __Тип__                     |__Синтаксис__ | __Пример__     |
|-----------------------------|--------------|----------------|
| Прямая абсолютная           | ADDR         | LD 0x01        |
| Прямая относительная        | [IP+N]       | LD [IP + 0x01] |
| Косвенная относительная     | [ADDR]       | LD [0x01]      |
| Косвенная автоинкрементная  | [ADDR]+      | LD [0x93]+     |
| Косвенная автодекрементная  | [ADDR]-      | LD [0x93]-     |


### Организация памяти

---

Память команд и данных общая. Существует также DataStack, который может быть использован программистом  

Память соответствует фон Неймановской архитектуре. Память программы состоит из: 1 элемент хранит в себе адрес начала хранения переменных, дальше хранятся машинные слова от первого элемента до переменных, после хранятся сами переменные. Обращение к памяти производится через регистр AR

Примечание: команды хранятся в одной памяти с данными, в виде объектов класса Instruction, дабы избежать парсинга из числового формата

## Транслятор

---

Интерфейс командной строки: `translator.py <source.file> <target.file>`     
Реализован в [translator.py](translator.py)

#### Этапы транслирования

1. Проверка корректности программы (пересечение меток, закрывающие скобки)
2. Трансформирование текста в машинный код
3. Подстановка численных значений вместо меток


### Модель процессора

Интерфейс командной строки: `machine.py <machine_code_file> <input_file> <log_file>`

#### DataPath

![datapath](images/DataPath.png)   
Реализован в классе [DataPath](src/machine.py)  
`IP` - регистр для хранения адреса исполняемой инструкции  
`AR` - регистр для хранения адреса, по которому программа обращается к памяти  
`TOS` - регистр для хранения вершины стека  
`DR` - регистр для чтения/записи в память   
`BR` - регистр для промежуточного хранения из DataStack (для операции SWAP)   
`DataStack` - стек данных  
`Memory` - общая память программы  
На схеме также изображены сигналы, которые приходят из `ControlUnit`, по которым выполняется определенное действие  

#### ControlUnit

![control_unit](images/ControlUnit.png)   
Реализован в классе [ControlUnit](src/machine.py)  
`CR` - регистр для хранения исполняемой инструкции   
`ReturnStack` - стек возвратов (возврат из подпрограммы)   
`Opcode decoder` - обработчик команд

### Тестирование

---


